services:

  # ── SQL Server 2022 ─────────────────────────────────────────
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    platform: linux/amd64
    container_name: aims-sqlserver
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=AIMS@2025!
      - MSSQL_PID=Developer
    ports:
      - "1433:1433"
    volumes:
      - sqldata:/var/lib/mssql/data
    healthcheck:
      test: >
        /opt/mssql-tools18/bin/sqlcmd
        -S localhost -U sa -P "AIMS@2025!"
        -No -Q "SELECT 1"
        || /opt/mssql-tools/bin/sqlcmd
        -S localhost -U sa -P "AIMS@2025!"
        -Q "SELECT 1"
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 45s   # ← Tăng lên 45s cho ARM64 (chậm hơn do Rosetta)
  # ── Backend API ─────────────────────────────────────────────
  aims-api:
    build:
      context: .
      dockerfile: src/AIMS.BackendServer/Dockerfile
    container_name: aims-api
    ports:
      - "5001:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__DefaultConnection=Server=sqlserver;Database=AIMS;User Id=sa;Password=AIMS@2025!;TrustServerCertificate=True;
      - JwtSettings__Key=AIMS_SECRET_KEY_2025_DEHA_VIET_NAM_VERY_LONG_MIN32CHARS
      - JwtSettings__Issuer=AIMS.BackendServer
      - JwtSettings__Audience=AIMS.WebPortal
      - JwtSettings__ExpiryMinutes=60
    depends_on:
      sqlserver:
        condition: service_healthy
    restart: on-failure          # ← Tự restart nếu crash
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 5
  # ── Web Portal MVC ──────────────────────────────────────────
  aims-web:
    build:
      context: .
      dockerfile: src/AIMS.WebPortal/Dockerfile
    container_name: aims-web
    ports:
      - "5005:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ApiSettings__BaseUrl=http://aims-api:8080
    volumes:
      - webkeys:/app/dataprotection-keys
    depends_on:
      - aims-api
    restart: on-failure

volumes:
  sqldata:
  webkeys: